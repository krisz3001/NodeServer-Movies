<!DOCTYPE html>
<html lang="hu" class="h-100">
<head>
  <title><%= title %></title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="icon" href="/favicon.ico">
  <link rel="stylesheet" href="/assets/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    #profile{
        height: 40px;
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        aspect-ratio: 1/1;
        transition: .15s ease-in-out;
      }
  </style>
</head>
<!-- <% let next_link; let o = ' opacity-0 disabled'
      if(type=='series'){
        if(filename.split('_')[2].split('.')[0] != episodes[seasons-1] || episodes.length != filename.split('_')[1]){
          o = ''
          let dir = filename.split('_')[0].split('/')[0]
          let s = filename.split('_')[1]*1
          let e = filename.split('_')[2].split('.')[0]*1
          if(e == episodes[s-1]) next_link = `/series/${id}/${dir}/${s+1}/1`
          else next_link = `/series/${id}/${dir}/${s}/${e+1}`}
      }
      %>
        <li class="nav-item m-2">
          <a href="<%= next_link %>" class="btn btn-success<%=o%>">Next episode</a>
        </li>
		  <% if(type=='series' && !(filename.split('_')[1] == 1 && filename.split('_')[2].split('.')[0] == 1)){
        let dir = filename.split('_')[0].split('/')[0]
        let s = filename.split('_')[1]*1
        let e = filename.split('_')[2].split('.')[0]*1
        let prev_link
        if(e == 1) prev_link = `/series/${id}/${dir}/${s-1}/${episodes[s-2]}`
        else prev_link = `/series/${id}/${dir}/${s}/${e-1}`
      %>
        <li class="nav-item m-2">
          <a href="<%= prev_link %>" class="btn btn-success">Previous episode</a>
        </li>
      <% } %> -->
<body id="main" class="bg-dark text-white overflow-hidden d-flex align-items-center h-100" onload="getID('<%= id %>', '<%= filename %>', '<%= type %>'); getProgress('<%= id %>', '<%= type %>', '<%= filename %>')" onbeforeunload="saveProgress()" onmousemove="showCursor(); afk()">
  <div class="h-100 w-100">
    <video id="vid" onplay="clearTimeout(timeout); hideCursor(); startAutosave()" ondblclick="full()" onpause="saveProgress(); afk(); clearInterval(autosave); clearTimeout(cursorTimer)" ontimeupdate="progressBar()" style="object-fit: cover; height: 100%!important;" class="w-100" src="/media/<%= filename %>"></video>
    <div style="width: 0; height: 5px; background-color: red; position: absolute; bottom: 0; left: 0; top: auto; transition: 0.5s ease;" id="p"></div>
    <div id="controls" class="position-absolute w-100 h-100 d-flex" style="top: 0; left: 0;" onclick="videoClick()" ondblclick="full()">
      <div id="topLine" class="w-100" style="height: 50px; padding-top: 10px; padding-left: 10px;">
        <a href="/" style="background-image: url('/assets/back.png'); background-size: contain; height: 100%; aspect-ratio: 1/1; display: block;"></a>
      </div>
    </div>
    <div id="overlay" onmousemove="hideOverlay()" on class="position-absolute w-100 h-100 d-none" style="top: 0; left: 0; align-items: center; background-color: rgba(0, 0, 0, 0.5);">
      <div class="mx-5">
        <p class="m-0">You are watching:</p>
        <h1 class="m-0"><%= title %></h1>
        <p class="m-0">Hova a faszba ment√©l?</p>
      </div>
      </div>
    <div id="init" onkeydown="playVideo(event)" onclick="playVideo()" class="position-absolute w-100 bg-dark h-100 d-flex" style="top: 0; left: 0; cursor: pointer; background-image: url('/assets/<%= image %>'); background-size: contain; background-position: center; background-repeat: no-repeat; align-items: center; justify-content: center;">
      <img src="/assets/play1.png" style="width: 60px; height: 60px;">
    </div>
    <!-- <div id="init" onclick="play()" style="cursor: pointer; width: 100%; height: 100%; background-image: url('/assets/<%= image %>'); background-size: contain; background-position: center; background-repeat: no-repeat; align-items: center; justify-content: center;" class="bg-dark border border-secondary d-flex">
      <img src="/assets/play.png" style="width: 60px; height: 60px;">
    </div> -->
  </div>
  <script>
    let vid = document.getElementById('vid')
    let autosave
    function startAutosave(){
      autosave = setInterval(saveProgress, 60000)
    }
    function playVideo(){
      document.getElementById('init').classList.add('d-none')
      vid.play()
    }
    function getProgress(id, type, filename){
      let formData = new FormData()
      if(type == 'movie'){
        formData.append("id", id)
        formData.append("type", type)
        fetch('/getprogress', {method: "POST", body : formData})
          .then(response => response.json())
          .then(r => {
              vid.currentTime = r.current
          })
      } 
      else{
        formData.append("id", id)
        formData.append("type", type)
        formData.append("filename", filename)
        console.log(filename);
        fetch('/getprogress', {method: "POST", body : formData})
          .then(response => response.json())
          .then(r => {
              vid.currentTime = r.current
          })
      }
    }
    let timeout
    let cursorTimer
    function afk(){
      if(vid.paused){
        clearTimeout(timeout)
        timeout = setTimeout(showOverlay,10000)
      }
    }
    function showOverlay(){
      document.getElementsByTagName('body')[0].style.cursor = 'none'
      document.getElementById('overlay').classList.add('d-flex')
      document.getElementById('overlay').classList.remove('d-none')
    }
    function hideOverlay(){
      timeout = setTimeout(showOverlay,10000)
      document.getElementsByTagName('body')[0].style.cursor = 'default'
      document.getElementById('overlay').classList.remove('d-flex')
      document.getElementById('overlay').classList.add('d-none')
    }
    function full(){
      document.documentElement.requestFullscreen()
    }
    function hideCursor(){
      clearTimeout(cursorTimer)
      cursorTimer = setTimeout(() => {
        if(!vid.paused) document.getElementsByTagName('body')[0].style.cursor = 'none'
        else clearTimeout(cursorTimer)
      }, 2000);
    }
    function showCursor(){
      document.getElementsByTagName('body')[0].style.cursor = 'default'
      if(!vid.paused) hideCursor()
    }
    function videoClick(){
      if(vid.paused){
        vid.play()
      }
      else vid.pause()
    }
    document.addEventListener('keydown', function(e){
      if(e.keyCode == 32){
        if(vid.paused){
        vid.play()
        }
        else vid.pause()
      }
    })
  </script>
	<script src="/assets/script.js"></script>
</body>
</html>